<!DOCTYPE html>
<html lang="en">
<head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-176574648-1"></script>
    <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-176574648-1');
    </script>
    
    <link rel='stylesheet' href='/static/css/pygment_trac.css'/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,500,500i,600,600i,700,700i&display=swap' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <title>ActiveJ | ByteBuf, lightweight alternative to Java NIO ByteBuffers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=" Lightweight alternative to Java NIO ByteBuffers with extremely low GC footprint. ">
    <meta name="keywords" content=" bytebuffer,byte buffers,java nio,bytebuffer alternative,java,java framework ">
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <meta name="og:description" content="ActiveJ is an alternative Java platform built from the ground up as a replacement of Spring, Spark, Quarkus, Micronauts, and other solutions. It is minimalistic, boilerplate-free, and provides outstanding performance." />
    <meta name="og:image" content="https://activej.io/static/images/AJ_Card.jpeg" />
    <meta name="og:title" content="ActiveJ - An Alternative Java platform built for web, high load, and cloud development" />
</head>
<body>
    <div class="navbar-container-wrapper">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
            <ul class="navbar-nav-visible mr-auto mt-1 mt-lg-0">
                <div class="logo-link-title mr-5">
                    <img src="/favicon.png" style="max-width: 25px">
                    
                    
                    <a class="navbar-nav__link logo-link-title" href="/" style="margin-left: 5px">ActiveJ</a>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </div>
            </ul>
            <button class="navbar-toggler m-1 ml-auto" type="button" data-toggle="collapse" data-target="#navbarToggler"
                    aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarToggler">
                <div class="container">
                    
                    
                    <ul class="navbar-nav navbar-nav-visible mr-auto mt-1 mt-lg-0">
                        
                        <li>
                            <a class="navbar-nav__link nav-expanded" href="/tutorials/getting-started.html">
                                Tutorials
                            </a>
                        </li>
                        
                        <li>
                            <a class="navbar-nav__link nav-expanded" href="/http.html">
                                Docs
                            </a>
                        </li>
                        
                    </ul>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </div>
                <span>
              <ul class="navbar-nav expanded-links navbar-nav-visible mr-auto mt-1 mt-lg-0">
                  <li class="dropdown">
                    <a class="nav-link nav-expanded">Components</a>
                    <ul class="dropdown__content">
                        
                            <div class="dropdown__content-wrapper">
                                
                                    <a href="https://activej.io" class="dropdown__content__item  selected-link ">
                                        <li>
                                            <div href="https://activej.io">ActiveJ</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Redefining Java for modern web applications </p>
                                    </a>
                                
                                    <a href="https://inject.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://inject.activej.io">ActiveJ Inject</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Lightning-fast and ultimately powerful DI library </p>
                                    </a>
                                
                                    <a href="https://serializer.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://serializer.activej.io">ActiveJ Serializer</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> The fastest JVM serializer in the world </p>
                                    </a>
                                
                                    <a href="https://codegen.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://codegen.activej.io">ActiveJ Codegen</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Dynamic bytecode generation without overhead of reflection </p>
                                    </a>
                                
                                    <a href="https://specializer.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://specializer.activej.io">ActiveJ Specializer</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> A little bit of magic to speed up your code </p>
                                    </a>
                                
                                    <a href="https://rpc.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://rpc.activej.io">ActiveJ RPC</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Lightning-fast binary protocol for microservices architecture </p>
                                    </a>
                                
                                    <a href="https://fs.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://fs.activej.io">ActiveJ FS</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Tiny abstraction for managing local, remote, and distributed FS </p>
                                    </a>
                                
                           </div>
                        
                    </ul>
                </li>
                  <li><a class="navbar-nav__link" href="https://activej.io/blog/release-notes.html">Blog</a> </li>
                <li><a class="navbar-nav__link" href="http://uikernel.io">UIKernel</a></li>
                <li><a class="navbar-nav__link" href="https://adkernel.com">AdKernel</a></li>
                <li><a class="navbar-nav__link" href="https://github.com/activej/activej">GitHub</a></li>
                <li><a class="navbar-nav__link" href="/about.html">About us</a></li>
              </ul>
            </span>
            </div>
        </nav>
    </div>
</div>

    <div class="content">
        
            <div class="container">
                <div class="row">
                    <div class="px-0 mb-3 sidebar">
    
<h3>Async I/O</h3>
<ul>
    
    
    <li>
        <a href="/http.html">HTTP</a>
    </li>
    
    
    
    <li>
        <a href="/eventloop.html">Eventloop</a>
    </li>
    
    
    
    <li>
        <a href="/promise.html">Promise</a>
    </li>
    
    
    
    <li>
        <a href="/csp.html">CSP</a>
    </li>
    
    
    
    <li>
        <a href="/datastream.html">Datastream</a>
    </li>
    
    
    
    <li>
        <a href="/net.html">Net</a>
    </li>
    
    
    
    <li>
        <a href="/dataflow.html">Dataflow</a>
    </li>
    
    
</ul>

<h3>Boot</h3>
<ul>
    
    
    <li>
        <a href="/launcher.html">Launcher</a>
    </li>
    
    
    
    <li>
        <a href="/service-graph.html">Service Graph</a>
    </li>
    
    
    
    <li>
        <a href="/workers.html">Workers</a>
    </li>
    
    
    
    <li>
        <a href="/config.html">Config</a>
    </li>
    
    
</ul>

<h3>Misc</h3>
<ul>
    
    
    <li class="sidebar-item-selected-wrapper">
        <div class="sidebar-item-selected">
            <a href="/bytebuf.html">ByteBuf</a>
        </div>
    </li>
    
    
    
    <li>
        <a href="/codec.html">Codec</a>
    </li>
    
    
</ul>

</div>
<div class="pr-3 markdown-content docs-content">
    <div class="status-wrapper">
        <h1>ByteBuf </h1>
    </div>
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#overview">Overview</a></li>
<li class="toc-entry toc-h2"><a href="#bytebuf">ByteBuf</a></li>
<li class="toc-entry toc-h2"><a href="#bytebufpool">ByteBufPool</a></li>
<li class="toc-entry toc-h2"><a href="#bytebufs">ByteBufs</a></li>
<li class="toc-entry toc-h2"><a href="#utility-classes">Utility classes</a></li>
<li class="toc-entry toc-h2"><a href="#examples">Examples</a>
<ul>
<li class="toc-entry toc-h3"><a href="#bytebuf-example">ByteBuf Example</a></li>
<li class="toc-entry toc-h3"><a href="#bytebuf-pool-example">ByteBuf Pool Example</a></li>
<li class="toc-entry toc-h3"><a href="#bytebufs-example">ByteBufs Example</a></li>
</ul>
</li>
</ul><h2 id="overview">
<a class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h2>

<p>ActiveJ aims to make efficient yet high-level I/O. This requires extensive usage of user-space 
byte buffers. Unfortunately, traditional Java <strong>ByteBuffer</strong>s impose a heavy load on GC.</p>

<p>To reduce GC overhead, ActiveJ introduces its own GC-friendly and lightweight <a href="#bytebuf">ByteBufs</a>, which can be 
reused with <a href="#bytebufpool">ByteBufPool</a>.</p>

<p>In addition, common I/O pattern is to treat <strong>ByteBuffer</strong>s as a queue: I/O operation produces the data while application 
consumes the data or vice versa. <strong>ByteBuf</strong>s are designed to facilitate this pattern as well, providing<br>
specialized <a href="#bytebufs">ByteBufs</a> class with queue-like operations across multiple <strong>ByteBuf</strong>s.</p>

<h2 id="bytebuf">
<a class="anchor" href="#bytebuf" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>ByteBuf</strong>
</h2>
<p>An extremely lightweight and efficient implementation compared to the Java NIO <strong>ByteBuffer</strong>. There are no direct buffers, 
which simplifies and improves <a href="https://github.com/activej/activej/blob/v4.3/core-bytebuf/src/main/java/io/activej/bytebuf/ByteBuf.java"><strong>ByteBuf</strong></a> performance.</p>

<p><strong>ByteBuf</strong> is similar to a FIFO byte queue and has two positions: <em>head</em> and <em>tail</em>. When you write data to 
<strong>ByteBuf</strong>, it’s <em>tail</em> increases by the number of bytes written. Similarly, when you read data from <strong>ByteBuf</strong>,
it’s <em>head</em> increases by the number of bytes read.</p>

<p>You can read bytes from <strong>ByteBuf</strong> only when its <em>tail</em> is greater than the <em>head</em>. Similarly, you can write bytes to 
<strong>ByteBuf</strong> until the <em>tail</em> doesn’t exceed the length of the wrapped array. In this way, there is no need for <code class="language-plaintext highlighter-rouge">ByteBuffer.flip()</code> operations.</p>

<p><strong>ByteBuf</strong> supports concurrent processes: while one process writes some data to the <strong>ByteBuf</strong>, another process can 
read it.</p>

<p>To create a <strong>ByteBuf</strong> you can either wrap your byte array into <strong>ByteBuf</strong> or allocate it from <strong>ByteBufPool</strong>.</p>
<div class="note-wrapper">
    <div class="note">
        <b>Note:</b>
        If you create a <b>ByteBuf</b> without allocating it from <b>ByteBufPool</b>, calling <i>ByteBuf.recycle()</i> will have no effect, such <b>ByteBuf</b>s are simply collected by GC.
    </div>
</div>

<h2 id="bytebufpool">
<a class="anchor" href="#bytebufpool" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>ByteBufPool</strong>
</h2>

<p><strong>ByteBufPool</strong> allows to reuse <strong>ByteBuf</strong>s and as a result, reduces GC load. To make <a href="https://github.com/activej/activej/blob/v4.3/core-bytebuf/src/main/java/io/activej/bytebuf/ByteBufPool.java"><strong>ByteBufPool</strong></a> usage more 
convenient, there are debugging and monitoring tools for allocated <strong>ByteBuf</strong>s, including their stack traces.</p>

<p>To get a <strong>ByteBuf</strong> from the pool, use <code class="language-plaintext highlighter-rouge">ByteBufPool.allocate(int size)</code>. A <strong>ByteBuf</strong> of the rounded up to the next 
nearest power of 2 size will be allocated (for example, if the <em>size</em> is 29, a <strong>ByteBuf</strong> of 32 bytes will be allocated).</p>

<p>To return <strong>ByteBuf</strong> to the <strong>ByteBufPool</strong>, use <code class="language-plaintext highlighter-rouge">ByteBuf.recycle()</code>. In contrast to languages like C/C++, it’s not required 
to recycle <strong>ByteBuf</strong>s - in the worst case, they will be collected by the GC.</p>

<p>To make everything consistent, ActiveJ relies on the concept of ‘ownership’ (like in Rust language) - after allocation, 
the components pass a <em>byteBuf</em> from one to another, until the last ‘owner’ recycles it to <strong>ByteBufPool</strong>.</p>

<p>You can explore an example of <strong>ByteBufPool</strong> use case <a href="#bytebuf-pool-example">here</a></p>

<h2 id="bytebufs">
<a class="anchor" href="#bytebufs" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>ByteBufs</strong>
</h2>
<p><a href="https://github.com/activej/activej/blob/v4.3/core-bytebuf/src/main/java/io/activej/bytebuf/ByteBufs.java"><strong>ByteBufs</strong></a> 
class provides effective management of multiple <strong>ByteBuf</strong>s. It creates an optimized queue of several 
ByteBufs with FIFO rules.</p>

<p>You can explore an example of <strong>ByteBufs</strong> use case <a href="#bytebufs-example">here</a></p>

<h2 id="utility-classes">
<a class="anchor" href="#utility-classes" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>Utility classes</strong>
</h2>
<p>ByteBuf module also contains <a href="https://github.com/activej/activej/blob/v4.3/core-bytebuf/src/main/java/io/activej/bytebuf/util">utility classes</a> to manage and resize the underlying byte buffer, <strong>String</strong> conversions, etc.</p>

<h2 id="examples">
<a class="anchor" href="#examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples</h2>
<p>1.<a href="#bytebuf-example">ByteBuf Example</a> - represents some basic <strong>ByteBuf</strong> possibilities, such as:</p>
<ul>
  <li>wrapping data in <strong>ByteBuf</strong> for writing/reading,</li>
  <li>slicing particular parts out of data,</li>
  <li>conversions.</li>
</ul>

<p>2.<a href="#bytebuf-pool-example">ByteBuf Pool Example</a> - represents how to work with <strong>ByteBufPool</strong>.</p>

<p>3.<a href="#bytebufs-example">ByteBufs Example</a> - shows how queues of <strong>ByteBuf</strong>s are created and processed.</p>

<div class="note-wrapper">
    <div class="note">
        <b>Note:</b>
        To run the examples, you need to clone ActiveJ from GitHub: 
<br> <b>$ git clone https://github.com/activej/activej</b> 
<br> And import it as a Maven project. Check out tag <b>v4.3</b>. Before running the examples, build the project.
<br> These examples are located at <b>activej -&gt; examples -&gt; core -&gt; bytebuf.</b>
    </div>
</div>

<h3 id="bytebuf-example">
<a class="anchor" href="#bytebuf-example" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>ByteBuf Example</strong>
</h3>
<p>If you run the example, you’ll receive the following output:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">0
1
2
3
4
5

<span class="o">[</span>0, 1, 2, 3, 4, 5]

Hello

Sliced <span class="k">**</span>ByteBuf<span class="k">**</span> array: <span class="o">[</span>1, 2, 3]

Array of <span class="k">**</span>ByteBuf<span class="k">**</span> converted from <span class="k">**</span>ByteBuffer<span class="k">**</span>: <span class="o">[</span>1, 2, 3]</code></pre></figure>

<ul>
  <li>The first six lines are a result of wrapping a byte array to a <strong>ByteBuf</strong> wrapper for reading and then printing it:</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">};</span>
<span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForReading</span><span class="o">(</span><span class="n">data</span><span class="o">);</span></code></pre></figure>

<ul>
  <li>The line <code class="language-plaintext highlighter-rouge">[0, 1, 2, 3, 4, 5]</code> is a result of converting an empty array of bytes to <strong>ByteBuf</strong> and wrapping them for 
writing. Then the <strong>ByteBuf</strong> was filled with bytes with the help of <code class="language-plaintext highlighter-rouge">while</code> loop:</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">6</span><span class="o">];</span>
<span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForWriting</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
<span class="kt">byte</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">while</span> <span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">canWrite</span><span class="o">())</span> <span class="o">{</span>
	<span class="n">byteBuf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">value</span><span class="o">++);</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li>“Hello” line was first converted from String to <strong>ByteBuf</strong> and wrapped for reading, then represented as a String for 
output with the help of <em>byteBuf.asString()</em>:</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Hello"</span><span class="o">;</span>
<span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForReading</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">));</span>
<span class="nc">String</span> <span class="n">unWrappedMessage</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">asString</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">);</span></code></pre></figure>

<ul>
  <li>The last two outputs represent some other possibilities of <strong>ByteBuf</strong>, such as slicing:</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">};</span>
<span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
<span class="nc">ByteBuf</span> <span class="n">slice</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">slice</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span></code></pre></figure>

<p>and conversions of default <strong>ByteBuffer</strong> to <strong>ByteBuf</strong>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">20</span><span class="o">],</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">toWriteByteBuffer</span><span class="o">();</span>
<span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">2</span><span class="o">);</span>
<span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">3</span><span class="o">);</span>
<span class="n">byteBuf</span><span class="o">.</span><span class="na">ofWriteByteBuffer</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span></code></pre></figure>

<p><a href="https://github.com/activej/activej/blob/v4.3/examples/core/bytebuf/src/main/java/ByteBufExample.java"><strong>See full example on GitHub</strong></a></p>

<h3 id="bytebuf-pool-example">
<a class="anchor" href="#bytebuf-pool-example" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>ByteBuf Pool Example</strong>
</h3>
<p>If you run the example, you’ll receive the following output:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Length of array of allocated ByteBuf: 128
Number of ByteBufs <span class="k">in </span>pool before recycling: 0
Number of ByteBufs <span class="k">in </span>pool after recycling: 1
Number of ByteBufs <span class="k">in </span>pool: 0

Size of ByteBuf: 4
Remaining bytes of ByteBuf after 3 bytes have been written: 1
Remaining bytes of a new ByteBuf: 5

<span class="o">[</span>0, 1, 2, 3, 4, 5]</code></pre></figure>

<p>Let’s have a look at the implementation:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ByteBufPoolExample</span> <span class="o">{</span>
	<span class="cm">/* Setting ByteBufPool minSize and maxSize properties here for illustrative purposes.
	 Otherwise, ByteBufs with size less than 32 would not be placed into pool
	 */</span>
	<span class="kd">static</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"ByteBufPool.minSize"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">allocatingBufs</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// Allocating a ByteBuf of 100 bytes</span>
		<span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>

		<span class="c1">// Allocated ByteBuf has an array with size equal to next power of 2, hence 128</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Length of array of allocated ByteBuf: "</span> <span class="o">+</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">writeRemaining</span><span class="o">());</span>

		<span class="c1">// Pool has 0 ByteBufs right now</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Number of ByteBufs in pool before recycling: "</span> <span class="o">+</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">getStats</span><span class="o">().</span><span class="na">getPoolItems</span><span class="o">());</span>

		<span class="c1">// Recycling ByteBuf to put it back to pool</span>
		<span class="n">byteBuf</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>

		<span class="c1">// Now pool consists of 1 ByteBuf that is the one we just recycled</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Number of ByteBufs in pool after recycling: "</span> <span class="o">+</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">getStats</span><span class="o">().</span><span class="na">getPoolItems</span><span class="o">());</span>

		<span class="c1">// Trying to allocate another ByteBuf</span>
		<span class="nc">ByteBuf</span> <span class="n">anotherByteBuf</span> <span class="o">=</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">123</span><span class="o">);</span>

		<span class="c1">// Pool is now empty as the only ByteBuf in pool has just been taken from the pool</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Number of ByteBufs in pool: "</span> <span class="o">+</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">getStats</span><span class="o">().</span><span class="na">getPoolItems</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">ensuringWriteRemaining</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

		<span class="c1">// Size is equal to power of 2 that is larger than 3, hence 4</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Size of ByteBuf: "</span> <span class="o">+</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">writeRemaining</span><span class="o">());</span>

		<span class="n">byteBuf</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">});</span>

		<span class="c1">// After writing 3 bytes into ByteBuf we have only 1 spare byte in ByteBuf</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining bytes of ByteBuf after 3 bytes have been written: "</span> <span class="o">+</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">writeRemaining</span><span class="o">());</span>

		<span class="c1">// We need to write 3 more bytes so we have to ensure that there are 3 spare bytes in ByteBuf</span>
		<span class="c1">// and if there are not - create new ByteBuf with enough room for 3 bytes (old ByteBuf will get recycled)</span>
		<span class="nc">ByteBuf</span> <span class="n">newByteBuf</span> <span class="o">=</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">ensureWriteRemaining</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Amount of ByteBufs in pool:"</span> <span class="o">+</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">getStats</span><span class="o">().</span><span class="na">getPoolItems</span><span class="o">());</span>

		<span class="c1">// As we need to write 3 more bytes, we need a ByteBuf that can hold 6 bytes.</span>
		<span class="c1">// The next power of 2 is 8, so considering 3 bytes that have already been written, new ByteBuf</span>
		<span class="c1">// can store (8-3=5) more bytes</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Remaining bytes of a new ByteBuf: "</span> <span class="o">+</span> <span class="n">newByteBuf</span><span class="o">.</span><span class="na">writeRemaining</span><span class="o">());</span>

		<span class="c1">// Recycling a new ByteBuf (remember, the old one has already been recycled)</span>
		<span class="n">newByteBuf</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">appendingBufs</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">ByteBuf</span> <span class="n">bufOne</span> <span class="o">=</span> <span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForReading</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">});</span>
		<span class="nc">ByteBuf</span> <span class="n">bufTwo</span> <span class="o">=</span> <span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForReading</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">});</span>

		<span class="nc">ByteBuf</span> <span class="n">appendedBuf</span> <span class="o">=</span> <span class="nc">ByteBufPool</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">bufOne</span><span class="o">,</span> <span class="n">bufTwo</span><span class="o">);</span>

		<span class="c1">// Appended ByteBuf consists of two ByteBufs, you don't have to worry about allocating ByteBuf</span>
		<span class="c1">// with enough capacity or how to properly copy bytes, ByteBufPool will handle it for you</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">appendedBuf</span><span class="o">.</span><span class="na">asArray</span><span class="o">()));</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">allocatingBufs</span><span class="o">();</span>
		<span class="n">ensuringWriteRemaining</span><span class="o">();</span>
		<span class="n">appendingBufs</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><a href="https://github.com/activej/activej/blob/v4.3/examples/core/bytebuf/src/main/java/ByteBufPoolExample.java"><strong>See full example on GitHub</strong></a></p>

<h3 id="bytebufs-example">
<a class="anchor" href="#bytebufs-example" aria-hidden="true"><span class="octicon octicon-link"></span></a><strong>ByteBufs Example</strong>
</h3>
<p>If you run the example, you’ll receive the following output:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">bufs:2 bytes:7

Buf taken from bufs: <span class="o">[</span>0, 1, 2, 3]

Buf taken from bufs: <span class="o">[</span>3, 4, 5, 6, 7, 8]

<span class="o">[</span>1, 2, 3, 4]
<span class="o">[</span>5, 6, 7, 8]
Is <span class="s1">'ByteBufs'</span> empty? <span class="nb">true</span></code></pre></figure>

<p>The first line represents our queue after we’ve added two bufs: <code class="language-plaintext highlighter-rouge">[0, 1, 2, 3]</code> and <code class="language-plaintext highlighter-rouge">[3, 4, 5]</code> with <code class="language-plaintext highlighter-rouge">BUFS.add()</code> method.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="no">BUFS</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForReading</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">}));</span>
<span class="no">BUFS</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForReading</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">}));</span>

<span class="c1">// bufs consist of 2 Bufs at this moment</span></code></pre></figure>

<p>Then method <code class="language-plaintext highlighter-rouge">BUFS.take()</code> is applied and the first added buf, which is <code class="language-plaintext highlighter-rouge">[0, 1, 2, 3]</code>, is taken from the queue.</p>

<p>The next line represents the result of two operations: adding a new <code class="language-plaintext highlighter-rouge">[6, 7, 8]</code> buf and then applying 
<code class="language-plaintext highlighter-rouge">BUFS.takeRemaining()</code> which takes all the remaining bufs from the queue.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Adding one more ByteBuf to bufs</span>
<span class="no">BUFS</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ByteBuf</span><span class="o">.</span><span class="na">wrapForReading</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">}));</span>

<span class="nc">ByteBuf</span> <span class="n">takenBuf</span> <span class="o">=</span> <span class="no">BUFS</span><span class="o">.</span><span class="na">takeRemaining</span><span class="o">();</span>

<span class="c1">// Taken ByteBuf is combined of every ByteBuf that were in bufs</span></code></pre></figure>

<div class="note-wrapper">
    <div class="note">
        <b>Note:</b>
        pay attention to the difference between <i>take()</i> and <i>poll()</i> <b>ByteBufs</b> 
methods. When using <i>take()</i>, you must be sure that there is at least one <b>ByteBuf</b> remaining in the queue, otherwise 
use <i>poll()</i> which can return <b>null</b>.
    </div>
</div>

<p>Finally, the last three lines represent the following operations:</p>

<ul>
  <li>Creating two bufs: <code class="language-plaintext highlighter-rouge">[1, 2, 3, 4]</code> and <code class="language-plaintext highlighter-rouge">[5, 6, 7, 8]</code>.</li>
  <li>Draining the queue to the consumer which prints the bufs.</li>
  <li>Then we check if the queue is empty now.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"></code></pre></figure>

<p><a href="https://github.com/activej/activej/blob/v4.3/examples/core/bytebuf/src/main/java/ByteBufsExample.java"><strong>See full example on GitHub</strong></a></p>

    <div class="row docs-prevnext">
        
            <div class="col-sm-6">
                <a class="docs-prevnext__button pull-left" href="net.html">Prev</a>
            </div>
        
        
            <div class="col-sm-6">
                <a class="docs-prevnext__button pull-right" href="codec.html">Next</a>
            </div>
        
    </div>
</div>


                </div>
            </div>
        
        <div class="container justify-content-between footer">
            <div class="col-md-4 col-lg-5"> &copy; 2021 ActiveJ LLC. All Rights Reserved</div>
            <div class="col-md-4 col-lg-3">Contact us: contact@activej.io</div>
            <div class="col-md-8 col-lg-4 footer__menu">
                <a href="http://uikernel.io">UIKernel</a>
                <a href="https://adkernel.com">AdKernel</a>
                <a href="https://github.com/activej/activej">GitHub</a>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
    <script src="../static/js/leon.js"></script>
    <script src="../static/js/index.js"></script>
    <script
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous">
    </script>
</body>
</html>
