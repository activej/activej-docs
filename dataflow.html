<!DOCTYPE html>
<html lang="en">
<head>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-176574648-1"></script>
    <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-176574648-1');
    </script>
    
    <link rel='stylesheet' href='/static/css/pygment_trac.css'/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,500,500i,600,600i,700,700i&display=swap' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <title>ActiveJ | Dataflow, distributed stream-based batch processing engine</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content=" Dataflow is an efficient tool for big data distributed applications. It offers a high-performance stream-based batch processing engine for working with partitions ">
    <meta name="keywords" content=" java,dataflow,big data,streams,batch processing ">
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    <meta name="og:description" content="ActiveJ is an alternative Java platform built from the ground up as a replacement of Spring, Spark, Quarkus, Micronauts, and other solutions. It is minimalistic, boilerplate-free, and provides outstanding performance." />
    <meta name="og:image" content="https://activej.io/static/images/AJ_Card.jpeg" />
    <meta name="og:title" content="ActiveJ - An Alternative Java platform built for web, high load, and cloud development" />
</head>
<body>
    <div class="navbar-container-wrapper">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
            <ul class="navbar-nav-visible mr-auto mt-1 mt-lg-0">
                <div class="logo-link-title mr-5">
                    <img src="/favicon.png" style="max-width: 25px">
                    
                    
                    <a class="navbar-nav__link logo-link-title" href="/" style="margin-left: 5px">ActiveJ</a>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </div>
            </ul>
            <button class="navbar-toggler m-1 ml-auto" type="button" data-toggle="collapse" data-target="#navbarToggler"
                    aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarToggler">
                <div class="container">
                    
                    
                    <ul class="navbar-nav navbar-nav-visible mr-auto mt-1 mt-lg-0">
                        
                        <li>
                            <a class="navbar-nav__link nav-expanded" href="/tutorials/getting-started.html">
                                Tutorials
                            </a>
                        </li>
                        
                        <li>
                            <a class="navbar-nav__link nav-expanded" href="/http.html">
                                Docs
                            </a>
                        </li>
                        
                    </ul>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </div>
                <span>
              <ul class="navbar-nav expanded-links navbar-nav-visible mr-auto mt-1 mt-lg-0">
                  <li class="dropdown">
                    <a class="nav-link nav-expanded">Components</a>
                    <ul class="dropdown__content">
                        
                            <div class="dropdown__content-wrapper">
                                
                                    <a href="https://activej.io" class="dropdown__content__item  selected-link ">
                                        <li>
                                            <div href="https://activej.io">ActiveJ</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Redefining Java for modern web applications </p>
                                    </a>
                                
                                    <a href="https://inject.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://inject.activej.io">ActiveJ Inject</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Lightning-fast and ultimately powerful DI library </p>
                                    </a>
                                
                                    <a href="https://serializer.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://serializer.activej.io">ActiveJ Serializer</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> The fastest JVM serializer in the world </p>
                                    </a>
                                
                                    <a href="https://codegen.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://codegen.activej.io">ActiveJ Codegen</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Dynamic bytecode generation without overhead of reflection </p>
                                    </a>
                                
                                    <a href="https://specializer.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://specializer.activej.io">ActiveJ Specializer</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> A little bit of magic to speed up your code </p>
                                    </a>
                                
                                    <a href="https://rpc.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://rpc.activej.io">ActiveJ RPC</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Lightning-fast binary protocol for microservices architecture </p>
                                    </a>
                                
                                    <a href="https://fs.activej.io" class="dropdown__content__item ">
                                        <li>
                                            <div href="https://fs.activej.io">ActiveJ FS</div>
                                        </li>
                                        <p class="dropdown__content__item__text"> Tiny abstraction for managing local, remote, and distributed FS </p>
                                    </a>
                                
                           </div>
                        
                    </ul>
                </li>
                  <li><a class="navbar-nav__link" href="https://activej.io/blog/release-notes.html">Blog</a> </li>
                <li><a class="navbar-nav__link" href="http://uikernel.io">UIKernel</a></li>
                <li><a class="navbar-nav__link" href="https://adkernel.com">AdKernel</a></li>
                <li><a class="navbar-nav__link" href="https://github.com/activej/activej">GitHub</a></li>
                <li><a class="navbar-nav__link" href="/about.html">About us</a></li>
              </ul>
            </span>
            </div>
        </nav>
    </div>
</div>

    <div class="content">
        
            <div class="container">
                <div class="row">
                    <div class="px-0 mb-3 sidebar">
    
<h3>Async I/O</h3>
<ul>
    
    
    <li>
        <a href="/http.html">HTTP</a>
    </li>
    
    
    
    <li>
        <a href="/eventloop.html">Eventloop</a>
    </li>
    
    
    
    <li>
        <a href="/promise.html">Promise</a>
    </li>
    
    
    
    <li>
        <a href="/csp.html">CSP</a>
    </li>
    
    
    
    <li>
        <a href="/datastream.html">Datastream</a>
    </li>
    
    
    
    <li>
        <a href="/net.html">Net</a>
    </li>
    
    
    
    <li class="sidebar-item-selected-wrapper">
        <div class="sidebar-item-selected">
            <a href="/dataflow.html">Dataflow</a>
        </div>
    </li>
    
    
</ul>

<h3>Boot</h3>
<ul>
    
    
    <li>
        <a href="/launcher.html">Launcher</a>
    </li>
    
    
    
    <li>
        <a href="/service-graph.html">Service Graph</a>
    </li>
    
    
    
    <li>
        <a href="/workers.html">Workers</a>
    </li>
    
    
    
    <li>
        <a href="/config.html">Config</a>
    </li>
    
    
</ul>

<h3>Misc</h3>
<ul>
    
    
    <li>
        <a href="/bytebuf.html">ByteBuf</a>
    </li>
    
    
    
    <li>
        <a href="/codec.html">Codec</a>
    </li>
    
    
</ul>

</div>
<div class="pr-3 markdown-content docs-content">
    <div class="status-wrapper">
        <h1>Dataflow </h1>
    </div>
    <p>Dataflow is a distributed stream-based batch processing engine for big data applications.
You can create tasks on your client that will be executed on Dataflow servers with datasets. The task compiles into an
execution graph that will be executed on partitions.</p>

<h2 id="example">Example</h2>
<p>In this example we will posts a simple Map-Reduce task to a cluster of Dataflow nodes.</p>

<div class="note-wrapper">
    <div class="note">
        <b>Note:</b>
        To run the examples, you need to clone ActiveJ from GitHub: 
<br /> <b>$ git clone https://github.com/activej/activej</b> 
<br /> And import it as a Maven project. Check out tag <b>v4.3</b>. Before running the examples, build the project. 
<br /> These examples are located at <b>activej -&gt; examples -&gt; core -&gt; dataflow.</b>
    </div>
</div>

<h3 id="1-create-a-dataflow-server-launcher">1. Create a Dataflow Server Launcher</h3>
<p>First, we need to launch two Dataflow servers. Each of them will have its own “items” dataset that contains 10K random 
words that can overlap. 
To create a Dataflow server launcher we’ll use pre-defined <a href="https://github.com/activej/activej/blob/v4.3/launchers/dataflow/src/main/java/io/activej/launchers/dataflow/DataflowServerLauncher.java"><strong>DataflowServerLauncher</strong></a> 
class that extends <a href="/launcher"><strong>Launcher</strong></a> class.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DataflowServerLauncherExample</span> <span class="kd">extends</span> <span class="nc">DataflowServerLauncher</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">Module</span> <span class="nf">getOverrideModule</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">ModuleBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">codec</span><span class="o">(</span><span class="nc">CreateStringCountFunction</span><span class="o">.</span><span class="na">class</span><span class="o">)).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">ofObject</span><span class="o">(</span><span class="nl">CreateStringCountFunction:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>
				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">codec</span><span class="o">(</span><span class="nc">ExtractStringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">)).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">ofObject</span><span class="o">(</span><span class="nl">ExtractStringFunction:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>
				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">codec</span><span class="o">(</span><span class="nc">StringCountReducer</span><span class="o">.</span><span class="na">class</span><span class="o">)).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">ofObject</span><span class="o">(</span><span class="nl">StringCountReducer:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>

				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="nc">StreamSorterStorageFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toInstance</span><span class="o">(</span><span class="nc">StreamMergeSorterStorageStub</span><span class="o">.</span><span class="na">FACTORY_STUB</span><span class="o">)</span>

				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toInstance</span><span class="o">(</span>
						<span class="nc">Config</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
								<span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"dataflow.server.listenAddresses"</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">:</span> <span class="s">"9000"</span><span class="o">)</span>
								<span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"dataflow.secondaryBufferPath"</span><span class="o">,</span> <span class="nc">Util</span><span class="o">.</span><span class="na">createTempDir</span><span class="o">(</span><span class="s">"dataflow-server-secondary-storage"</span><span class="o">)))</span>
				<span class="o">.</span><span class="na">build</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Provides</span>
	<span class="nd">@DatasetId</span><span class="o">(</span><span class="s">"items"</span><span class="o">)</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">words</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">:</span> <span class="s">"words1.txt"</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">file</span><span class="o">)))</span>
				<span class="o">.</span><span class="na">lines</span><span class="o">()</span>
				<span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span>
				<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="k">new</span> <span class="nf">DataflowServerLauncherExample</span><span class="o">().</span><span class="na">launch</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>First, override <em>getOverrideModule</em> method to create an abstract module with all the needed bindings: 
<a href="https://github.com/activej/activej/blob/v4.3/examples/core/dataflow/src/main/java/dto/CreateStringCountFunction.java">CreateStringCountFunction</a>, 
<a href="https://github.com/activej/activej/blob/v4.3/examples/core/dataflow/src/main/java/dto/ExtractStringFunction.java">ExtractStringFunction</a>, 
<a href="https://github.com/activej/activej/blob/v4.3/examples/core/dataflow/src/main/java/dto/StringCountReducer.java">StringCountReducer</a>, 
<a href="https://github.com/activej/activej/blob/v4.3/extra/cloud-dataflow/src/main/java/io/activej/dataflow/node/NodeSort.java#L42">StreamSorterStorageFactory</a>, and <a href="/config">Config</a>.
Next, we create <em>words</em> method to efficiently retrieve a list of Strings from the <code class="language-plaintext highlighter-rouge">.txt</code> file.</p>

<p>Finally, we define <em>main</em> method for starting our launcher.</p>

<p><a href="https://github.com/activej/activej/blob/v4.3/examples/core/dataflow/src/main/java/DataflowServerLauncherExample.java">See Dataflow server launcher source code on GitHub</a></p>

<h3 id="2-create-a-dataflow-client-launcher-with-a-task">2. Create a Dataflow Client Launcher with a task</h3>
<p>Let’s now create a Dataflow client launcher. We’ll make it by analogy with the server launcher. So we override 
<em>getOverrideModule</em> and provide the same required dependencies:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DataflowClientLauncherExample</span> <span class="kd">extends</span> <span class="nc">DataflowClientLauncher</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_PARTITION</span> <span class="o">=</span> <span class="s">"127.0.0.1:9000"</span><span class="o">;</span>

	<span class="nd">@Inject</span>
	<span class="nc">DataflowClient</span> <span class="n">client</span><span class="o">;</span>

	<span class="nd">@Inject</span>
	<span class="nc">DataflowGraph</span> <span class="n">graph</span><span class="o">;</span>

	<span class="nd">@Inject</span>
	<span class="nc">Eventloop</span> <span class="n">eventloop</span><span class="o">;</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">Module</span> <span class="nf">getOverrideModule</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">ModuleBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">codec</span><span class="o">(</span><span class="nc">CreateStringCountFunction</span><span class="o">.</span><span class="na">class</span><span class="o">)).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">ofObject</span><span class="o">(</span><span class="nl">CreateStringCountFunction:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>
				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">codec</span><span class="o">(</span><span class="nc">ExtractStringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">)).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">ofObject</span><span class="o">(</span><span class="nl">ExtractStringFunction:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>
				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">codec</span><span class="o">(</span><span class="nc">StringCountReducer</span><span class="o">.</span><span class="na">class</span><span class="o">)).</span><span class="na">toInstance</span><span class="o">(</span><span class="n">ofObject</span><span class="o">(</span><span class="nl">StringCountReducer:</span><span class="o">:</span><span class="k">new</span><span class="o">))</span>

				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="nc">StreamSorterStorageFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toInstance</span><span class="o">(</span><span class="nc">StreamMergeSorterStorageStub</span><span class="o">.</span><span class="na">FACTORY_STUB</span><span class="o">)</span>

				<span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toInstance</span><span class="o">(</span>
						<span class="nc">Config</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
								<span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"dataflow.secondaryBufferPath"</span><span class="o">,</span> <span class="nc">Util</span><span class="o">.</span><span class="na">createTempDir</span><span class="o">(</span><span class="s">"dataflow-client-secondary-storage"</span><span class="o">))</span>
								<span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"dataflow.partitions"</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="no">DEFAULT_PARTITION</span> <span class="o">:</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">args</span><span class="o">)))</span>
				<span class="o">.</span><span class="na">build</span><span class="o">();</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>Now let’s create a task for our Dataflow partitions. We’ll define it in the overridden Launcher’s main method <em>run</em>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
	<span class="n">eventloop</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
		<span class="nc">StringCountReducer</span> <span class="n">reducer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringCountReducer</span><span class="o">();</span>
		<span class="nc">ExtractStringFunction</span> <span class="n">keyFunction</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExtractStringFunction</span><span class="o">();</span>

		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="n">datasetOfId</span><span class="o">(</span><span class="s">"items"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">StringCount</span><span class="o">&gt;</span> <span class="n">mappedItems</span> <span class="o">=</span> <span class="n">map</span><span class="o">(</span><span class="n">items</span><span class="o">,</span> <span class="k">new</span> <span class="nc">CreateStringCountFunction</span><span class="o">(),</span> <span class="nc">StringCount</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

		<span class="nc">LocallySortedDataset</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">StringCount</span><span class="o">&gt;</span> <span class="n">locallySorted</span> <span class="o">=</span> <span class="n">localSort</span><span class="o">(</span><span class="n">mappedItems</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">keyFunction</span><span class="o">,</span> <span class="n">naturalOrder</span><span class="o">());</span>

		<span class="nc">LocallySortedDataset</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">StringCount</span><span class="o">&gt;</span> <span class="n">locallyReduced</span> <span class="o">=</span> <span class="n">localReduce</span><span class="o">(</span><span class="n">locallySorted</span><span class="o">,</span> <span class="n">reducer</span><span class="o">.</span><span class="na">inputToAccumulator</span><span class="o">(),</span> <span class="nc">StringCount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">keyFunction</span><span class="o">);</span>

		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">StringCount</span><span class="o">&gt;</span> <span class="n">reducedItems</span> <span class="o">=</span> <span class="n">repartitionReduce</span><span class="o">(</span><span class="n">locallyReduced</span><span class="o">,</span> <span class="n">reducer</span><span class="o">.</span><span class="na">accumulatorToOutput</span><span class="o">(),</span> <span class="nc">StringCount</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

		<span class="nc">MergeCollector</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">StringCount</span><span class="o">&gt;</span> <span class="n">collector</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MergeCollector</span><span class="o">&lt;&gt;(</span><span class="n">reducedItems</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="n">keyFunction</span><span class="o">,</span> <span class="n">naturalOrder</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>

		<span class="nc">StreamSupplier</span><span class="o">&lt;</span><span class="nc">StringCount</span><span class="o">&gt;</span> <span class="n">resultSupplier</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">graph</span><span class="o">);</span>

		<span class="nc">StreamConsumerToList</span><span class="o">&lt;</span><span class="nc">StringCount</span><span class="o">&gt;</span> <span class="n">resultConsumer</span> <span class="o">=</span> <span class="nc">StreamConsumerToList</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>

		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n *** Dataset graph:\n"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reducedItems</span><span class="o">.</span><span class="na">toGraphViz</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n *** Compiled nodes graph:\n"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">graph</span><span class="o">.</span><span class="na">toGraphViz</span><span class="o">());</span>

		<span class="n">graph</span><span class="o">.</span><span class="na">execute</span><span class="o">().</span><span class="na">both</span><span class="o">(</span><span class="n">resultSupplier</span><span class="o">.</span><span class="na">streamTo</span><span class="o">(</span><span class="n">resultConsumer</span><span class="o">))</span>
				<span class="o">.</span><span class="na">whenException</span><span class="o">(</span><span class="nl">Throwable:</span><span class="o">:</span><span class="n">printStackTrace</span><span class="o">)</span>
				<span class="o">.</span><span class="na">whenResult</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
					<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Top 100 words:"</span><span class="o">);</span>
					<span class="n">resultConsumer</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">limit</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
				<span class="o">})</span>
				<span class="o">.</span><span class="na">whenComplete</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">shutdown</span><span class="o">);</span>
	<span class="o">});</span>

	<span class="n">awaitShutdown</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
	<span class="k">new</span> <span class="nf">DataflowClientLauncherExample</span><span class="o">().</span><span class="na">launch</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>This code does the following:</p>
<ol>
  <li>Maps strings by creating <code class="language-plaintext highlighter-rouge">('word', 1)</code> pairs</li>
  <li>Sorts the pairs in alphabetic order by the String value</li>
  <li>Reduces the pairs by merging similar word pairs. For example, <code class="language-plaintext highlighter-rouge">(apple, 1)</code> and <code class="language-plaintext highlighter-rouge">(apple, 1)</code> will be reduced into <code class="language-plaintext highlighter-rouge">(apple, 2)</code></li>
  <li>Distributes the pairs according to a provided rule. For example, if <strong>partition 1</strong> contains <code class="language-plaintext highlighter-rouge">(apple, 2)</code>, <code class="language-plaintext highlighter-rouge">(dog, 2)</code> and 
<strong>partition 2</strong> contains <code class="language-plaintext highlighter-rouge">(apple, 3)</code>, <code class="language-plaintext highlighter-rouge">(dog, 1)</code> the result of repartitioning might be <code class="language-plaintext highlighter-rouge">(apple, 2)</code>, <code class="language-plaintext highlighter-rouge">(apple, 3)</code> on <strong>partition 1</strong> and 
<code class="language-plaintext highlighter-rouge">(dog, 2)</code>, <code class="language-plaintext highlighter-rouge">(dog, 1)</code> on <strong>partition 2</strong>.</li>
  <li>Repeats <strong>step 3</strong>. As a result of these steps, we receive a sorted and reduced dataset with unique items across all the partitions</li>
  <li>With the help of collector, client pulls streams from all the nodes and merges them into a single stream</li>
  <li>The stream is collected into a list that we can work with. In the example we simply print out the first 100 words</li>
</ol>

<p>Finally, we create <em>main</em> method that launches the client.</p>

<p><a href="https://github.com/activej/activej/blob/v4.3/examples/core/dataflow/src/main/java/DataflowClientLauncherExample.java">See Dataflow client launcher source code on GitHub</a></p>

<h3 id="testing">Testing</h3>
<p>First, launch two dataflow servers. You need to specify nodes’ addresses and source files as program arguments.
<strong>Server Launcher 1</strong> arguments: <code class="language-plaintext highlighter-rouge">9000 words1.txt</code>. <strong>Server Launcher 2</strong> arguments: <code class="language-plaintext highlighter-rouge">9001 words2.txt</code>.
Next, launch dataflow client to post the created task to the servers. You’ll need to specify the ports of the partitions 
as program arguments: <code class="language-plaintext highlighter-rouge">9000 9001</code>.</p>

<p>After everything is launched and the task is executed, in the console you will see the list of the first 100 words 
collected from the two dataflow servers.
All the data flows between partitions are represented in sysout and can be transformed into the following graph:</p>

<figure class="figure-image">
    <img src="/static/images/dataflow.png" style="max-width: 400px;" />
</figure>

    <div class="row docs-prevnext">
        
            <div class="col-sm-6">
                <a class="docs-prevnext__button pull-left" href="promise.html">Prev</a>
            </div>
        
        
            <div class="col-sm-6">
                <a class="docs-prevnext__button pull-right" href="datastream.html">Next</a>
            </div>
        
    </div>
</div>


                </div>
            </div>
        
        <div class="container justify-content-between footer">
            <div class="col-md-4 col-lg-5"> &copy; 2021 ActiveJ LLC. All Rights Reserved</div>
            <div class="col-md-4 col-lg-3">Contact us: contact@activej.io</div>
            <div class="col-md-8 col-lg-4 footer__menu">
                <a href="http://uikernel.io">UIKernel</a>
                <a href="https://adkernel.com">AdKernel</a>
                <a href="https://github.com/activej/activej">GitHub</a>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
    <script src="../static/js/leon.js"></script>
    <script src="../static/js/index.js"></script>
    <script
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous">
    </script>
</body>
</html>
