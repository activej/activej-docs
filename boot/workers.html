<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ActiveJ Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ActiveJ Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-176574648-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-176574648-1",{})</script><title data-react-helmet="true">ActiveJ | Workers, overcome the complexities and overheads of multithreaded programming model | ActiveJ</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://activej.io/boot/workers"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ActiveJ | Workers, overcome the complexities and overheads of multithreaded programming model | ActiveJ"><meta data-react-helmet="true" name="description" content="ActiveJ Workers allow to overcome the complexities and overheads of multithreaded programming model yet preserve Java multithreading capabilities"><meta data-react-helmet="true" property="og:description" content="ActiveJ Workers allow to overcome the complexities and overheads of multithreaded programming model yet preserve Java multithreading capabilities"><meta data-react-helmet="true" property="og:image" content="https://activej.io/img/preview.png"><meta data-react-helmet="true" name="twitter:image" content="https://activej.io/img/preview.png"><link data-react-helmet="true" rel="shortcut icon" href="/./img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://activej.io/boot/workers"><link data-react-helmet="true" rel="alternate" href="https://activej.io/boot/workers" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://activej.io/boot/workers" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.54128df1.css">
<link rel="preload" href="/assets/js/runtime~main.2803819b.js" as="script">
<link rel="preload" href="/assets/js/main.9f134463.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/./img/favicon.png" alt="Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/./img/favicon.png" alt="Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">ActiveJ</b></a><a class="navbar__item navbar__link navbar__link--active" href="/overview">Docs</a><a class="navbar__item navbar__link" href="/tutorials/getting-started">Tutorials</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/activej/activej" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/overview">Overview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Async I/O</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Boot</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/boot/launcher">Launcher</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/boot/servicegraph">Service Graph</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/boot/workers">Workers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/boot/config">Config</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">HTTP</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Inject</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Codegen</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Serializer</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Specializer</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">RPC</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">FS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Misc</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Workers</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>Workers (<a href="https://github.com/activej/activej/blob/v5.0-beta2/boot-workers/src/main/java/io/activej/worker/WorkerPoolModule.java" target="_blank"><code>WorkerPoolModule</code></a> in particular) is a handy way of
injecting multiple dependencies of the same type. It is useful when you need, for example, same set of dependencies for each thread. ActiveJ heavily utilizes workers
to implement multithreading. Workers are the base of ActiveJ threading model.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="activej-threading-model"></a>ActiveJ threading model<a class="hash-link" href="#activej-threading-model" title="Direct link to heading">#</a></h2><p>The primary mission of ActiveJ is to create ultimately fast, scalable, simple to use, and high-abstraction level I/O async
programming model.
To achieve this, ActiveJ design principles overcome all the performance overhead and complexities of the traditional
multithreaded programming model, yet fully utilize Java multithreading capabilities.
ActiveJ offers means of splitting the application into a <code>Primary Eventloop</code> thread and <code>Worker
Eventloop</code> threads. These threads communicate with each other via message passing and thread-safe application-specific
singleton services.</p><p><a href="/async-io/eventloop"><code>Eventloop</code></a> thread is essentially a single-threaded mini-application
(similar to Node.js), which handles its part of I/O tasks and executes Runnables submitted from other threads.
Primary Eventloop threads distribute and balance I/O tasks between Worker threads.</p><div class="mermaid">
graph TB
    id1(Primary Event Loop) --&gt; id2(Worker Balancer)
    id2 --&gt; id4
    subgraph Worker Scope
    id3(Event Loop) --&gt; id4(HTTP Server)
    end
    id2 --&gt; id6
    subgraph Worker Scope
    id5(Event Loop) --&gt; id6(HTTP Server)
    end
</div><p>The benefits of ActiveJ threading model:</p><ul><li>Each primary/worker Eventloop thread works as a single-threaded application, which is simple to program and to reason about</li><li>There is no multithreaded overhead, races, and thread synchronization overhead</li><li>Traditional strength of Java in multithreaded programming is fully preserved:</li><li>typical I/O load can be easily split between worker threads</li><li>the application can have thread-safe singleton services, which are used by Eventloop threads, and a huge singleton
data state, shared among all worker threads</li><li>you can still use some thread synchronization / lock-free algorithms, just try to avoid excessive blocking of
concurrent threads</li><li>full interoperability between Java Threads, Thread Pools, Java Futures, and even blocking I/O operations</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="worker-scope"></a>Worker Scope<a class="hash-link" href="#worker-scope" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="problem"></a>Problem<a class="hash-link" href="#problem" title="Direct link to heading">#</a></h3><p>This design raises some implementation questions.
For example, if we want to implement multithreaded HTTP web application with worker eventloops:</p><ul><li>according to these design principles, we need to create separate instances of a working eventloop, a single-threaded HTTP
server, and its servlets for each working thread</li><li>but what if our application has 8 eventloop threads with 10 worker-thread components inside, do we have to create 80 of
components in total and assign them to each worker thread?</li><li>how is it even possible to manually instantiate, wire, initialize, and start/stop all those components in a
correct order and also gracefully shutdown application on start/stop errors?</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="solution"></a>Solution<a class="hash-link" href="#solution" title="Direct link to heading">#</a></h3><p>Luckily, due to <a href="/inject">ActiveJ Inject</a>, we have a solution - <code>@Worker</code> scope. If you need to implement several worker threads:</p><ul><li>include <a href="https://github.com/activej/activej/blob/v5.0-beta2/boot-workers/src/main/java/io/activej/worker/WorkerPoolModule.java" target="_blank"><code>WorkerPoolModule</code></a>
module and create a <a href="https://github.com/activej/activej/blob/v5.0-beta2/boot-workers/src/main/java/io/activej/worker/WorkerPool.java" target="_blank"><code>WorkerPool</code></a> instance</li><li>annotate the components you wish to put into each worker thread with <code>@Worker</code> scope annotation</li></ul><p><strong>WorkerPool</strong> will automatically instantiate identical dependency graphs for each of those worker threads
You are by no means limited to the aforementioned scheme with one primary Eventloop and N worker eventloops:</p><ul><li>you can still have completely unrelated / standalone eventloops (nor primary, neither worker)</li><li>several primary eventloops sharing the same pool of worker eventloops or several sets of worker pools with different number or threads</li><li>you can even define your own <code>@Worker</code> annotations, and create multiple worker pools with completely unrelated and
different dependency graphs
All this is in fully transparent and easy-to-understand modules - just mark different components with appropriate
worker annotations and let <code>WorkerPool</code> create all the instances</li></ul><p>To automatically start/stop application components in correct order, simply include <code>ServiceGraph</code> module into your <strong>Launcher</strong> - it is aware of worker pools and will treat vectors of worker instances as special compound singleton-like instances.</p><p>For example, here is an example of utilizing <a href="https://github.com/activej/activej/blob/v5.0-beta2/launchers/http/src/main/java/io/activej/launchers/http/MultithreadedHttpServerLauncher.java" target="_blank"><code>MultithreadedHttpServerLauncher</code></a> which features <code>ServiceGraphModule</code>:</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">public final class MultithreadedHttpServerExample extends MultithreadedHttpServerLauncher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Worker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  AsyncServlet servlet(@WorkerId int workerId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return request -&gt; HttpResponse.ok200()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .withPlainText(&quot;Hello from worker server #&quot; + workerId + &quot;\n&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void main(String[] args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MultithreadedHttpServerExample example = new MultithreadedHttpServerExample();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    example.launch(args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>And its dependency graph looks as follows:</p><div class="mermaid">
graph
    subgraph &quot;@Worker()&quot;
    id1(AsyncHTTPServer) --&gt; id2(EventLoop)
    id1 --&gt; id3(Async Servlet)
    id3 --&gt; id4(&quot;@WorkerId() int&quot;)
    end
    id2 -.-&gt; ThrottlingController
    id2 --&gt; id5(Config)
    id1 --&gt; id5
    id9 --&gt; id5
    id6(EventLoop) --&gt; id5
    id7(Primary Server) --&gt; id5
    id7 --&gt; id6
    id7 --&gt; id8(WorkerPool$Intsnces)
    id8 --&gt; id9(WorkerPool)
    id9 --&gt; id10(WorkerPools)
    id10 --&gt; Injector
</div><p>To help you understand how worker pools work, here is a simplified <strong>WorkerPool</strong> implementation in a nutshell (the actual implementation differs, but not much):</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">public final class WorkerPool {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Scope scope;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Injector[] scopeInjectors;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkerPool(Injector injector, Scope scope, int workers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.scope = scope;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.scopeInjectors = new Injector[workers];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; workers; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            scopeInjectors[i] = injector.enterScope(scope, new HashMap&lt;&gt;(), false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; Instances&lt;T&gt; getInstances(Key&lt;T&gt; key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Instances&lt;T&gt; instances = new Instances&lt;&gt;(new Object[scopeInjectors.length]);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; scopeInjectors.length; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            instances.instances[i] = scopeInjectors[i].getInstance(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return instances;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>As you can see, the root <a href="https://github.com/activej/activej/blob/v5.0-beta2/core-inject/src/main/java/io/activej/inject/Injector.java" target="_blank"><code>Injector</code></a>
simply â€˜entersâ€™ the worker scope <code>N</code> times, so we have <code>N</code> <code>Injector</code>s with identical bindings/dependency graphs, but
different containers of instances. Each time we need to create some <em>worker</em> instances, they are created <code>N</code> times by
each <em>injector</em> and returned as a vector of <code>N</code> instances.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="examples"></a>Examples<a class="hash-link" href="#examples" title="Direct link to heading">#</a></h2><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>To run the examples, you need to clone ActiveJ from GitHub</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W shell"><pre tabindex="0" class="prism-code language-shell codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/activej/activej</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>And import it as a Maven project. Check out tag <strong>v5.0-beta2</strong>. Before running the examples, build the project.
These examples are located at <code>activej/examples/core/boot</code></p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="basic-worker-pool-example"></a>Basic Worker Pool Example<a class="hash-link" href="#basic-worker-pool-example" title="Direct link to heading">#</a></h3><p>An example of creating a worker pool with 4 workers:</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">public final class WorkerPoolModuleExample extends AbstractModule {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  WorkerPool workerPool(WorkerPools workerPools) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return workerPools.createPool(4);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Worker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  String string(@WorkerId int workerId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;Hello from worker #&quot; + workerId;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Injector injector = Injector.of(WorkerPoolModule.create(), new WorkerPoolModuleExample());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkerPool workerPool = injector.getInstance(WorkerPool.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkerPool.Instances&lt;String&gt; strings = workerPool.getInstances(String.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    strings.forEach(System.out::println);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>The dependency graph of the example includes the created worker pool and looks as follows:</p><div style="width:100%;display:flex"><img src="/img/worker-pool-dependencies_dark.svg" alt="Dependency graph" class="themedImage_1VuW themedImage--light_3UqQ" style="margin:0 auto"><img src="/img/worker-pool-dependencies_light.svg" alt="Dependency graph" class="themedImage_1VuW themedImage--dark_hz6m" style="margin:0 auto"></div><p><strong><a href="https://github.com/activej/activej/blob/v5.0-beta2/examples/core/boot/src/main/java/WorkerPoolModuleExample.java" target="_blank">See full example on GitHub</a></strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="multithreaded-worker-pools-collaboration"></a>Multithreaded Worker Pools Collaboration<a class="hash-link" href="#multithreaded-worker-pools-collaboration" title="Direct link to heading">#</a></h3><p>Several Worker Pools can co-work to calculate a single task. In this example we have 25 Workers and each of them has its
own Eventloop. These Eventloops are wrapped in Threads and then added to the list of <em>threads</em>. After that the
list is permuted and the threads with Eventloop tasks start. The task is to put Eventloop <em>id</em> in the <strong>ConcurrentLinkedQueue</strong>
in accordance to the delay (the <em>id</em> multiplied by 100). In this way we receive an ordered queue of Eventloop ids, after that
the Threads park and the queue is emptied.</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">public final class MultithreadedWorkerCollab extends AbstractModule {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Worker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Eventloop eventloop(@WorkerId int wid, ConcurrentLinkedQueue&lt;Integer&gt; queue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Eventloop eventloop = Eventloop.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    eventloop.delay(100L * wid, () -&gt; queue.add(wid));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return eventloop;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  WorkerPool workerPool(WorkerPools workerPools) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return workerPools.createPool(25);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConcurrentLinkedQueue&lt;Integer&gt; queue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ConcurrentLinkedQueue&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void main(String[] args) throws InterruptedException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Injector injector = Injector.of(WorkerPoolModule.create(), new MultithreadedWorkerCollab());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkerPool workerPool = injector.getInstance(WorkerPool.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WorkerPool.Instances&lt;Eventloop&gt; eventloops = workerPool.getInstances(Eventloop.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Thread&gt; threads = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Eventloop eventloop : eventloops.getList()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Thread thread = new Thread(eventloop);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      threads.add(thread);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Collections.shuffle(threads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    threads.forEach(Thread::start);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Thread thread : threads) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      thread.join();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentLinkedQueue&lt;Integer&gt; queue = injector.getInstance(new Key&lt;ConcurrentLinkedQueue&lt;Integer&gt;&gt;() {});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (!queue.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      System.out.println(queue.poll());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p><strong><a href="https://github.com/activej/activej/blob/v5.0-beta2/examples/core/boot/src/main/java/MultithreadedWorkerCollab.java" target="_blank">See full example on GitHub</a></strong></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/boot/servicegraph"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Service Graph</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/boot/config"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Config Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#activej-threading-model" class="table-of-contents__link">ActiveJ threading model</a></li><li><a href="#worker-scope" class="table-of-contents__link">Worker Scope</a><ul><li><a href="#problem" class="table-of-contents__link">Problem</a></li><li><a href="#solution" class="table-of-contents__link">Solution</a></li></ul></li><li><a href="#examples" class="table-of-contents__link">Examples</a><ul><li><a href="#basic-worker-pool-example" class="table-of-contents__link">Basic Worker Pool Example</a></li><li><a href="#multithreaded-worker-pools-collaboration" class="table-of-contents__link">Multithreaded Worker Pools Collaboration</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 ActiveJ LLC. All Rights Reserved</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2803819b.js"></script>
<script src="/assets/js/main.9f134463.js"></script>
</body>
</html>