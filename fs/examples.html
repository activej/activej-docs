<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ActiveJ 5.0 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ActiveJ 5.0 Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-176574648-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-176574648-1",{})</script><title data-react-helmet="true">Examples | ActiveJ 5.0</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://activej.io/img/preview.png"><meta data-react-helmet="true" name="twitter:image" content="https://activej.io/img/preview.png"><meta data-react-helmet="true" property="og:url" content="https://activej.io/fs/examples"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Examples | ActiveJ 5.0"><meta data-react-helmet="true" name="description" content="ActiveJ FS | Java library for efficient and scalable distributed storage with data redundancy, rebalancing, and resharding"><meta data-react-helmet="true" property="og:description" content="ActiveJ FS | Java library for efficient and scalable distributed storage with data redundancy, rebalancing, and resharding"><meta data-react-helmet="true" name="keywords" content="storage,distributed storage,redundancy,rebelancing,kernel-space,java framework,ftp protocol,append-only"><link data-react-helmet="true" rel="shortcut icon" href="/./img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://activej.io/fs/examples"><link data-react-helmet="true" rel="alternate" href="https://activej.io/fs/examples" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://activej.io/zh/fs/examples" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://activej.io/ru/fs/examples" hreflang="ru"><link data-react-helmet="true" rel="alternate" href="https://activej.io/fs/examples" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ebdfb6ec.css">
<link rel="preload" href="/assets/js/runtime~main.9e719efe.js" as="script">
<link rel="preload" href="/assets/js/main.72fd32cc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/./img/logo.webp" alt="Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/./img/logo.webp" alt="Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">ActiveJ</b></a><a class="navbar__item navbar__link navbar__link--active" href="/overview">Docs</a><a class="navbar__item navbar__link" href="/tutorials/getting-started">Tutorials</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/activej/activej" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Async I/O</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Boot</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">HTTP</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Inject</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Codegen</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Serializer</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Specializer</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">RPC</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">FS</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/fs">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/fs/examples">Examples</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Misc</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Examples</h1></header><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>To run the examples in an IDE, you need to clone ActiveJ project:</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W bash"><pre tabindex="0" class="prism-code language-bash codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/activej/activej</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>And import it as a Maven project. Check out branch <strong>v5.0</strong>. Before running the example, build the project (<strong>Ctrl + F9</strong> for IntelliJ IDEA).</p></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="server-setup">Server Setup<a aria-hidden="true" class="hash-link" href="#server-setup" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s have a closer look at <strong>Server Setup Example</strong>. To make setup and launching as simple as possible, there is a special <a href="https://github.com/activej/activej/blob/v5.0/launchers/fs/src/main/java/io/activej/launchers/fs/SimpleTcpServerLauncher.java" target="_blank"><code>SimpleTcpServerLauncher</code></a>, an <a href="/boot/launcher">ActiveJ <code>Launcher</code></a> implementation (abstracted implementation of <em>main</em> methods). It allows to simply set up applications, so all you need to set up an FS server is to override several Launcher methods:</p><ul><li><code>onInit</code> - runs prior to application start</li><li><code>getOverrideModule</code> - overrides Launcher&#x27;s default internal module definitions</li><li><code>run</code> - Launcher&#x27;s main method, represents business logic</li></ul><p>Then <em>launch</em> the <a href="https://github.com/activej/activej/blob/v5.0/launcher/src/main/java/io/activej/launcher/Launcher.java" target="_blank"><code>Launcher</code></a></p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">public class ServerSetupExample extends SimpleTcpServerLauncher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Path storage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected void onInit(Injector injector) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage = Files.createTempDirectory(&quot;server_storage&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected Config createConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return super.createConfig()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .with(&quot;activefs.path&quot;, storage.toString())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .with(&quot;activefs.listenAddresses&quot;, &quot;6732&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected void run() throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    awaitShutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void main(String[] args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Launcher launcher = new ServerSetupExample();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    launcher.launch(args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p><strong><a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/ServerSetupExample.java" target="_blank">See full example on GitHub</a></strong></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="file-upload">File Upload<a aria-hidden="true" class="hash-link" href="#file-upload" title="Direct link to heading">â€‹</a></h2><p><a href="#"><a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/FileUploadExample.java" target="_blank"><code>FileUploadExample</code></a></a>  also extends <code>Launcher</code> and thus implements the aforementioned <code>Launcher</code> methods.</p><p>In this example we will use a <a href="https://github.com/activej/activej/blob/v5.0/cloud-fs/src/main/java/io/activej/fs/ActiveFs.java" target="_blank">ActiveFs</a> instance which depends on asynchronous <a href="/async-io/eventloop">ActiveJ <strong>Eventloop</strong></a>
To simplify working with dependencies we will use <a href="/inject">ActiveJ Inject</a> DI library. It is lightning-fast, efficient and perfectly compatible with Launcher. So we simply <a href="https://github.com/activej/activej/blob/v5.0/core-inject/src/main/java/io/activej/inject/annotation/Inject.java" target="_blank"><code>@Inject</code></a> two instances and <a href="https://github.com/activej/activej/blob/v5.0/core-inject/src/main/java/io/activej/inject/annotation/Provides.java" target="_blank"><code>@Provides</code></a> factory methods.
Just like in the previous example, we will also overwrite <code>Launcher</code> methods <code>onInit</code>, <code>getOverrideModule</code>, and <code>run</code>.</p><p>Also, this example utilizes ActiveJ <a href="/async-io/csp">CSP</a> component, particularly <a href="https://github.com/activej/activej/blob/v5.0/core-csp/src/main/java/io/activej/csp/file/ChannelFileReader.java" target="_blank"><code>ChannelFileReader</code></a> class. It allows to asynchronously read binary data from files.</p><p>You can see full example sources on <a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/FileUploadExample.java" target="_blank"><strong>GitHub</strong></a>, here we will consider only the upload process that is defined in the overwritten method <code>run</code>.</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected void run() throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ExecutorService executor = newSingleThreadExecutor();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  CompletableFuture&lt;Void&gt; future = eventloop.submit(() -&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // consumer result here is a marker of it being successfully uploaded</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      ChannelFileReader.open(executor, clientFile)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .then(cfr -&gt; cfr.streamTo(client.upload(FILE_NAME, EXAMPLE_TEXT.length())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .whenResult(() -&gt; System.out.printf(&quot;%nFile &#x27;%s&#x27; successfully uploaded%n%n&quot;, FILE_NAME))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    future.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    executor.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p><strong><a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/FileUploadExample.java" target="_blank">See full example on GitHub</a></strong></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="file-download">File Download<a aria-hidden="true" class="hash-link" href="#file-download" title="Direct link to heading">â€‹</a></h2><p><a href="#"><a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/FileDownloadExample.java" target="_blank">FileDownloadExample</a></a> has an implementation that is similar to the <strong>File Upload</strong> example. Here we will consider only the download process that is defined in the overwritten method <code>run</code>.</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected void run() throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ExecutorService executor = newSingleThreadExecutor();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  CompletableFuture&lt;Void&gt; future = eventloop.submit(() -&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      ChannelSupplier.ofPromise(client.download(REQUIRED_FILE))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .streamTo(ChannelFileWriter.open(executor, clientStorage.resolve(DOWNLOADED_FILE)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .whenResult(() -&gt; System.out.printf(&quot;%nFile &#x27;%s&#x27; successfully downloaded to &#x27;%s&#x27;%n%n&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              REQUIRED_FILE, clientStorage))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    future.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    executor.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p><strong><a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/FileDownloadExample.java" target="_blank">See full example on GitHub</a></strong></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="activefs-decorator">ActiveFs Decorator<a aria-hidden="true" class="hash-link" href="#activefs-decorator" title="Direct link to heading">â€‹</a></h2><p>Sometimes you may need to override/expand the default behavior of <code>ActiveFs</code> implementation. To do so, you may utilize a <a href="https://en.wikipedia.org/wiki/Decorator_pattern" target="_blank" rel="noopener noreferrer">Decorator</a> pattern.</p><a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/DecoratedActiveFsExample.java" target="_blank">DecoratedActiveFsExample</a> demonstrates how to do just that. It decorates `ActiveFs` implementation by adding additional logging for file uploads and downloads.<p><code>DecoratedActiveFsExample</code> extends <code>ServerSetupExample</code> so it inherits its DI bindings. First, we need to override
the binding for <code>ActiveFsServer</code> to pass decorated <code>ActiveFs</code> instead of the original one. To do so, we will override
<code>Launcher#getOverrideModule</code> method and provide a new binding for <code>AsyncFsServer</code> that uses decorated <code>ActiveFs</code>.</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Module getOverrideModule() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return new AbstractModule() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Eager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActiveFsServer activeFsServer(Eventloop eventloop, @Named(&quot;decorated&quot;) ActiveFs decoratedFs, Config config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return ActiveFsServer.create(eventloop, decoratedFs)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .withInitializer(ofActiveFsServer(config.getChild(&quot;activefs&quot;)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Named(&quot;decorated&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActiveFs decoratedActiveFs(ActiveFs fs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new LoggingActiveFs(fs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>As you can see in <code>decoratedActiveFs(ActiveFs fs)</code> method, we request original <code>ActiveFs</code> and return the decorated one
(wrapped in <code>LoggingActiveFs</code>).</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">private static final class LoggingActiveFs extends ForwardingActiveFs {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Logger logger = LoggerFactory.getLogger(LoggingActiveFs.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public LoggingActiveFs(ActiveFs peer) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    super(peer);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Promise&lt;ChannelConsumer&lt;ByteBuf&gt;&gt; upload(@NotNull String name, long size) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return super.upload(name)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(consumer -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          logger.info(&quot;Starting upload of file: {}. File size is {} bytes&quot;, name, size);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          return consumer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .withAcknowledgement(ack -&gt; ack</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  .whenResult(() -&gt; logger.info(&quot;Upload of file {} finished&quot;, name)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Promise&lt;ChannelSupplier&lt;ByteBuf&gt;&gt; download(@NotNull String name, long offset, long limit) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return super.download(name, offset, limit)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(supplier -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          logger.info(&quot;Starting downloading file: {}&quot;, name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          return supplier</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .withEndOfStream(eos -&gt; eos</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  .whenResult(() -&gt; logger.info(&quot;Download of file {} finished&quot;, name)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p><code>LoggingActiveFs</code> extends <code>ForwardingActiveFs</code> which simply delegates all of the <code>ActiveFs</code> method calls to some underlying
<code>ActiveFs</code> instance. We override methods we want to decorate (<code>download</code>, <code>upload</code>) and add custom logging messages when
upload/download starts and finishes.</p><p>You can run <a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/FileUploadExample.java" target="_blank">FileUploadExample</a> followed by <a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/FileDownloadExample.java" target="_blank">FileDownloadExample</a>
After this you should see logging output:</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W text"><pre tabindex="0" class="prism-code language-text codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">INFO Starting upload of file: example.txt. File size is 12 bytes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO Upload of file example.txt finished</span></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO Starting downloading file: example.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO Download of file example.txt finished</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p><strong><a href="https://github.com/activej/activej/blob/examples-5.0/examples/cloud/fs/src/main/java/DecoratedActiveFsExample.java" target="_blank">See full example on GitHub</a></strong></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="cluster-file-storage">Cluster File Storage<a aria-hidden="true" class="hash-link" href="#cluster-file-storage" title="Direct link to heading">â€‹</a></h2><p>With ActiveJ FS you can simply create distributed cluster file storage with high fault tolerance. We will use Docker to launch three virtual servers and one client. The storage will support file uploads with automatic repartitioning according to the provided rule and replication count.</p><p>The first thing we need to do is to create a launcher class <code>ClusterTcpServerLauncher</code> for our server. Extend <a href="https://github.com/activej/activej/blob/v5.0/launchers/fs/src/main/java/io/activej/launchers/fs/SimpleTcpServerLauncher.java" target="_blank"><code>SimpleTcpServerLauncher</code></a> to get all the required instances: <a href="https://github.com/activej/activej/blob/v5.0/cloud-fs/src/main/java/io/activej/fs/tcp/ActiveFsServer.java" target="_blank"><code>ActiveFsServer</code></a>, local <a href="https://github.com/activej/activej/blob/v5.0/cloud-fs/src/main/java/io/activej/fs/ActiveFs.java" target="_blank"><code>ActiveFS</code></a>, <a href="https://github.com/activej/activej/blob/v5.0/core-http/src/main/java/io/activej/http/AsyncHttpServer.java" target="_blank"><code>AsyncHttpServer</code></a> for GUI that will simplify working with your storage, and other helper instances. In the <code>ClusterTcpServerLauncher</code> we&#x27;ll only need to set up utils for repartitioning management like task schedulers, <a href="https://github.com/activej/activej/blob/v5.0/cloud-fs/src/main/java/io/activej/fs/cluster/ClusterRepartitionController.java" target="_blank"><code>ClusterRepartitionController</code></a>, and <a href="https://github.com/activej/activej/blob/v5.0/cloud-fs/src/main/java/io/activej/fs/cluster/FsPartitions.java" target="_blank"><code>FsPartitions</code></a> for tracking alive partitions and their statuses. The partitions will communicate via TCP protocol, while GUI server will use HTTP.</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Eager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Named(&quot;repartition&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">EventloopTaskScheduler repartitionScheduler(Config config, ClusterRepartitionController controller) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return EventloopTaskScheduler.create(controller.getEventloop(), controller::repartition)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .withInitializer(ofEventloopTaskScheduler(config.getChild(&quot;activefs.repartition&quot;)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Eager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Named(&quot;clusterDeadCheck&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">EventloopTaskScheduler deadCheckScheduler(Config config, FsPartitions partitions) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return EventloopTaskScheduler.create(partitions.getEventloop(), partitions::checkDeadPartitions)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .withInitializer(ofEventloopTaskScheduler(config.getChild(&quot;activefs.repartition.deadCheck&quot;)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ClusterRepartitionController repartitionController(Config config, ActiveFsServer localServer, FsPartitions partitions) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  String localPartitionId = first(partitions.getAllPartitions());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  assert localPartitionId != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return ClusterRepartitionController.create(localPartitionId, partitions)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .withInitializer(ofClusterRepartitionController(config.getChild(&quot;activefs.repartition&quot;)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DiscoveryService discoveryService(Eventloop eventloop, ActiveFs activeFs, Config config) throws MalformedDataException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return Initializers.constantDiscoveryService(eventloop, activeFs, config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">FsPartitions fsPartitions(Eventloop eventloop, DiscoveryService discoveryService, OptionalDependency&lt;ServerSelector&gt; serverSelector) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return FsPartitions.create(eventloop, discoveryService)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .withServerSelector(serverSelector.orElse(RENDEZVOUS_HASH_SHARDER));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>Now we can move on to creating a client launcher <code>ClusterTcpClientLauncher</code>. We need to provide <code>ClusterRepartitionController</code> and a task scheduler to detect dead partitions. Similarly to the server launcher, we need to provide an <code>AsyncHttpServer</code> for GUI and <code>FsPartitions</code> for managing partitions. We also need an instance of <a href="https://github.com/activej/activej/blob/v5.0/cloud-fs/src/main/java/io/activej/fs/cluster/ClusterActiveFs.java" target="_blank">ClusterActiveFs</a> class, an <code>ActiveFs</code> implementation that operates on other partitions as a cluster and contains some redundancy and fail-safety capabilities.</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W java"><pre tabindex="0" class="prism-code language-java codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Eager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Named(&quot;clusterDeadCheck&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">EventloopTaskScheduler deadCheckScheduler(Config config, FsPartitions partitions) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return EventloopTaskScheduler.create(partitions.getEventloop(), partitions::checkDeadPartitions)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .withInitializer(ofEventloopTaskScheduler(config.getChild(&quot;activefs.repartition.deadCheck&quot;)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Eager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">AsyncHttpServer guiServer(Eventloop eventloop, AsyncServlet servlet, Config config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return AsyncHttpServer.create(eventloop, servlet)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .withInitializer(ofHttpServer(config.getChild(&quot;activefs.http.gui&quot;)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">AsyncServlet guiServlet(ActiveFs activeFs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return ActiveFsGuiServlet.create(activeFs, &quot;Cluster FS Client&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ActiveFs remoteActiveFs(Eventloop eventloop, FsPartitions partitions, Config config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return ClusterActiveFs.create(partitions)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .withInitializer(ofClusterActiveFs(config.getChild(&quot;activefs.cluster&quot;)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DiscoveryService discoveryService(Eventloop eventloop, Config config) throws MalformedDataException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return Initializers.constantDiscoveryService(eventloop, config.getChild(&quot;activefs.cluster&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">FsPartitions fsPartitions(Eventloop eventloop, DiscoveryService discoveryService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return FsPartitions.create(eventloop, discoveryService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>Here&#x27;s the architecture of our distributed P2P storage:</p><img src="/img/activefs_light.svg" alt="Distributed P2P storage" class="themedImage_1VuW themedImage--light_3UqQ" style="width:100%"><img src="/img/activefs_dark.svg" alt="Distributed P2P storage" class="themedImage_1VuW themedImage--dark_hz6m" style="width:100%"><p>You can create as many partitions as you wish.</p><p>To launch the example, run the following scripts to create Docker images and build containers (run all the scripts under
<code>activej/launchers/fs</code> directory):</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W bash"><pre tabindex="0" class="prism-code language-bash codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># building two images for server and client</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t cluster-server -f ClusterServerDockerfile </span><span class="token builtin class-name">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t cluster-client -f ClusterClientDockerfile </span><span class="token builtin class-name">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># launching all the servers and client instances in background</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose up -d</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p>The containers will be built with the following configurations:</p><ul><li><strong>Server1</strong>: TCP-connection port <code>9001</code>, HTTP GUI port <code>8081</code></li><li><strong>Server2</strong>: TCP-connection port <code>9002</code>, HTTP GUI port <code>8082</code></li><li><strong>Server3</strong>: TCP-connection port <code>9003</code>, HTTP GUI port <code>8083</code></li><li><strong>Client</strong>: HTTP GUI port <code>8080</code></li></ul><p>Use this script to manage containers:</p><div class="codeBlockContainer_2gih"><div class="codeBlockContent_3z4W bash"><pre tabindex="0" class="prism-code language-bash codeBlock_6upA thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xlV7"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># to stop a single container:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose stop server1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># to stop all the containers:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose down</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># check containers status:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose </span><span class="token function" style="color:#d73a49">ps</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_2e3i clean-btn">Copy</button></div></div><p><strong><a href="https://github.com/activej/activej/blob/v5.0/launchers/fs" target="_blank">See full example on GitHub</a></strong></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/fs"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/misc/bytebuf"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Bytebuf<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#server-setup" class="table-of-contents__link toc-highlight">Server Setup</a></li><li><a href="#file-upload" class="table-of-contents__link toc-highlight">File Upload</a></li><li><a href="#file-download" class="table-of-contents__link toc-highlight">File Download</a></li><li><a href="#activefs-decorator" class="table-of-contents__link toc-highlight">ActiveFs Decorator</a></li><li><a href="#cluster-file-storage" class="table-of-contents__link toc-highlight">Cluster File Storage</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 ActiveJ LLC. All Rights Reserved</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9e719efe.js"></script>
<script src="/assets/js/main.72fd32cc.js"></script>
</body>
</html>